/*! proj5mapapp 2015-11-12 */
function setUpMap(){mapViewModel.setUpLocation(),window.addEventListener("resize",function(a){mapViewModel.map.fitBounds(mapViewModel.bounds)})}function setUpLists(){listViewModel.setCityList(),listViewModel.setPlaceTypeList()}var dataModel={listOfPlaces:[],listOfAddresses:[],cities:[{city:"Washington,DC",cityName:"Washington, DC"},{city:"Chicago",cityName:"Chicago"},{city:"manhattan",cityName:"New York City"},{city:"Philadelphia",cityName:"Philadelphia"},{city:"San Francisco",cityName:"San Francisco"},{city:"Berlin, Germany",cityName:"Berlin, Germany"},{city:"London, England",cityName:"London, England"},{city:"Paris, France",cityName:"Paris, France"},{city:"Sydney, Australia",cityName:"Sydney, Australia"}],placeTypes:[{searchPlaceType:"museum",placeType:"museums"},{searchPlaceType:"park",placeType:"parks"},{searchPlaceType:"restaurant",placeType:"restaurants"}],mapIconsNormal:{museum:"images/red-dot.png",park:"images/park.png",restaurant:"images/restaurant.png"},mapIconsHover:{museum:"images/blue-dot.png",park:"images/hoverPark.png",restaurant:"images/hoverPlate.png"},mapIconsVisited:{museum:"images/purple.png",park:"images/visitedPark.png",restaurant:"images/visitedPlate.png"},addNewPlace:function(a){dataModel.listOfPlaces.push(a)},addAddress:function(a,b){dataModel.listOfAddresses[a]=b},getCities:function(){return dataModel.cities},getPlaceTypes:function(){return dataModel.placeTypes},getListOfPlaces:function(){return dataModel.listOfPlaces},getListOfAddresses:function(){return dataModel.listOfAddresses},initList:function(){dataModel.listOfPlaces.splice(0,dataModel.listOfPlaces.length)},initListOfAddresses:function(){dataModel.listOfAddresses.splice(0,dataModel.listOfAddresses.length)},getIcon:function(a,b){var c="";switch(a){case"normal":c=dataModel.mapIconsNormal[b];break;case"hover":c=dataModel.mapIconsHover[b];break;case"visited":c=dataModel.mapIconsVisited[b]}return c}},listViewModel={firstTime:!0,find:ko.observable(""),list:ko.observableArray([]),cityList:ko.observableArray([]),placeTypeList:ko.observableArray([]),selectedCity:ko.observable(),selectedPlaceType:ko.observable(),setCityList:function(){console.log("setCityList called"),cities=dataModel.getCities();for(var a in cities)listViewModel.cityList.push(cities[a])},setCity:function(a){setUpMap()},getCity:function(){return listViewModel.selectedCity()},getPlaceType:function(){return listViewModel.selectedPlaceType()},setPlaceTypeList:function(){placeTypes=dataModel.getPlaceTypes();for(var a in placeTypes)listViewModel.placeTypeList.push(placeTypes[a])},setPlaceType:function(a){console.log("setPlaceType called - onchange triggered"),listViewModel.firstTime?listViewModel.firstTime=!1:mapViewModel.setUpPlaces()},initListDisplay:function(){list=dataModel.getListOfPlaces().sort(),listViewModel.list.removeAll();for(var a in list)listViewModel.list.push(list[a])},bounceOn:function(a){mapViewModel.bounceOn(a)},bounceOff:function(a){mapViewModel.bounceOff(a)},openInfo:function(a){mapViewModel.openInfo(a)},changeLinkColor:function(a){a.style.color="#5011b3"},search:function(a){listViewModel.list.removeAll();var b=dataModel.getListOfPlaces();if(mapViewModel.resetMarkers(),""==a)for(var c in b)listViewModel.list.push(b[c]),mapViewModel.addBackMarker(b[c]);else for(var c in b)b[c].toLowerCase().indexOf(a.toLowerCase())>=0&&(listViewModel.list.push(b[c]),mapViewModel.addBackMarker(b[c]))}},mapViewModel={map:{},markerIconNormal:"",markerIconHover:"",markerIconVisited:"",lastMarkerIcon:"",lastInfoWindowOpen:"",infoWindowSet:{},markersSet:{},latlng:"",bounds:{},setUpLocation:function(){var a=listViewModel.getCity(),b=new google.maps.Geocoder,c={address:a};b.geocode(c,mapViewModel.checkStatus)},checkStatus:function(a,b){if(b==google.maps.GeocoderStatus.OK){var c=a[0].geometry.location.lat(),d=a[0].geometry.location.lng();mapViewModel.initMap(c,d)}else console.log("GeocoderStatus is not OK")},initMap:function(a,b){mapViewModel.latlng=new google.maps.LatLng(a,b);var c={center:mapViewModel.latlng,zoom:10,disableDefaultUI:!0};mapViewModel.map=new google.maps.Map(document.querySelector("#map"),c),mapViewModel.setUpPlaces()},resetMarkers:function(){if(mapViewModel.markersSet)for(var a in mapViewModel.markersSet)mapViewModel.markersSet[a].setMap(null)},displayAllMarkers:function(){if(mapViewModel.markersSet)for(var a in mapViewModel.markersSet)mapViewModel.markersSet[a].setMap(mapViewModel.map)},addBackMarker:function(a){mapViewModel.markersSet[a]?mapViewModel.markersSet[a].setMap(mapViewModel.map):console.log("marker for "+a+" not found")},initMarkers:function(){mapViewModel.markersSet&&(mapViewModel.resetMarkers(),mapViewModel.markersSet={})},setUpPlaces:function(){var a=listViewModel.getPlaceType(),b={location:mapViewModel.latlng,radius:5e3,rankBy:"rating",query:a,types:a};mapViewModel.initMarkers(),service=new google.maps.places.PlacesService(mapViewModel.map),service.textSearch(b,mapViewModel.processResults),window.mapBounds=new google.maps.LatLngBounds,mapViewModel.bounds=window.mapBounds},processResults:function(a,b){if(b==google.maps.places.PlacesServiceStatus.OK){dataModel.initList(),dataModel.initListOfAddresses();for(var c=listViewModel.getPlaceType(),d=0;d<a.length;d++)if(a[d].types.valueOf().indexOf(c)>=0){var e=a[d].name,f=a[d].formatted_address;$.inArray(e,dataModel.getListOfPlaces())<0&&(dataModel.addNewPlace(e),dataModel.addAddress(e,f),mapViewModel.createMapMarker(a[d]))}else console.log(a[d].name+" is not a "+c)}listViewModel.initListDisplay()},createMapMarker:function(a){var b=a.geometry.location.lat(),c=a.geometry.location.lng(),d=a.name,e=a.formatted_address,f=listViewModel.getCity(),g=(listViewModel.getPlaceType(),listViewModel.getPlaceType());mapViewModel.markerIconNormal=dataModel.getIcon("normal",g),mapViewModel.markerIconHover=dataModel.getIcon("hover",g),mapViewModel.markerIconVisited=dataModel.getIcon("visited",g);var h=new google.maps.Marker({map:mapViewModel.map,position:a.geometry.location,icon:mapViewModel.markerIconNormal,title:d+". Click to see reviews and learn more."});mapViewModel.markersSet[d]=h,api.callYelp(d,f),"restaurant"!=listViewModel.getPlaceType()&&api.callWiki(d);var i=new google.maps.InfoWindow({content:mapViewModel.formatInfoHtml(d,e),maxWidth:200,maxHeight:300});mapViewModel.infoWindowSet[d]=i,google.maps.event.addListener(h,"click",function(){mapViewModel.lastInfoWindowOpen?mapViewModel.lastInfoWindowOpen==i?(i.close(),mapViewModel.lastInfoWindowOpen=null):(mapViewModel.lastInfoWindowOpen.close(),i.open(mapViewModel.map,h),mapViewModel.lastInfoWindowOpen=i):(i.open(mapViewModel.map,h),mapViewModel.lastInfoWindowOpen=i),h.setIcon(mapViewModel.markerIconVisited),lastMarkerIcon=mapViewModel.markerIconVisited}),google.maps.event.addListener(h,"mouseover",function(){lastMarkerIcon=h.getIcon(),h.setIcon(mapViewModel.markerIconHover)}),google.maps.event.addListener(h,"mouseout",function(){h.setIcon(lastMarkerIcon)}),mapViewModel.bounds=window.mapBounds,mapViewModel.bounds.extend(new google.maps.LatLng(b,c)),mapViewModel.map.fitBounds(mapViewModel.bounds),mapViewModel.map.setCenter(mapViewModel.bounds.getCenter())},openInfo:function(a){var b=mapViewModel.infoWindowSet[a],c=mapViewModel.markersSet[a];b&&(mapViewModel.lastInfoWindowOpen?mapViewModel.lastInfoWindowOpen==b?(b.close(),mapViewModel.lastInfoWindowOpen=null):(mapViewModel.lastInfoWindowOpen.close(),b.open(mapViewModel.map,c),c.setAnimation(null),mapViewModel.lastInfoWindowOpen=b):(b.open(mapViewModel.map,c),c.setAnimation(null),mapViewModel.lastInfoWindowOpen=b)),c.setIcon(mapViewModel.markerIconVisited),lastMarkerIcon=c.getIcon()},setMarkerVisited:function(a){mapViewModel.markersSet[a]&&mapViewModel.markersSet[a].setIcon(mapViewModel.markerIconVisited)},bounceOn:function(a){mapViewModel.markersSet[a]&&(lastMarkerIcon=mapViewModel.markersSet[a].getIcon(),mapViewModel.markersSet[a].setIcon(mapViewModel.markerIconHover),mapViewModel.markersSet[a].setAnimation(google.maps.Animation.BOUNCE))},bounceOff:function(a){mapViewModel.markersSet[a]&&(mapViewModel.markersSet[a].setAnimation(null),mapViewModel.markersSet[a].setIcon(lastMarkerIcon))},formatInfoHtml:function(a,b,c){var d="";if(c){var e=dataModel.getListOfAddresses();c.url&&(d=d+'<a href="'+c.url+'" target="_blank" title="Click to read reviews">'+a+"</a><br>"),c.rating_img_url_small&&c.review_count&&(d=d+'<img src="images/yelp_logo_40x20.png" alt="Yelp logo image"></img><img src="'+c.rating_img_url_small+'" alt="Rating image"></img>'+c.review_count+" reviews"),c.snippet_text&&(d=d+'<p class="snippet">'+c.snippet_text+"</p>"),c.image_url&&(d=d+'<img src="'+c.image_url+'" height="100" width="100" alt="Reviewer image"></img>'),c.mobile_url&&(d=d+'<a href="'+c.mobile_url+'" target="_blank" title="Click to read reviews">Read reviews</a>'),e[a]&&(d=d+'<p class="snippet">Address: '+e[a]+"</p>"),b.indexOf("<a")>0&&(wiki_url=b.substr(b.indexOf("<a"),1e3),d+=wiki_url)}else d=0==a.indexOf("http")?b+'<a href="'+a+'" target="_blank" title="Click to read article">Wikipedia article</a>':"<p>"+a+'</p><p class="snippet">Address: '+b+"</p>";return d},addInfo:function(a,b,c){for(var d,e,f,g,h=!1,i=listViewModel.getPlaceType(),j=dataModel.getListOfPlaces(),k=0;k<a.businesses.length;k++){h=!1,e=a.businesses[k].name;for(var l in j){if(d=j[l],e.indexOf(d)>=0||d.indexOf(e)>=0){if("restaurant"==i){h=!0;break}for(var m in a.businesses[k].categories){for(var n in a.businesses[k].categories[m])if(a.businesses[k].categories[m][n].toLowerCase().indexOf(i)>=0){h=!0;break}if(h)break}}if(h)break}if(h&&mapViewModel.infoWindowSet[d]){g=mapViewModel.infoWindowSet[d].getContent(),-1==g.indexOf("review")&&(f=mapViewModel.formatInfoHtml(d,g,a.businesses[k]),mapViewModel.infoWindowSet[d].setContent(f));break}}},addWikiLink:function(a){var b="",c="",d=!1,e=a[0],f=a[3][0],g=dataModel.getListOfPlaces();for(var h in g)if(place=g[h],e.indexOf(place)>=0||place.indexOf(e)>=0){d=!0;break}d&&f&&mapViewModel.infoWindowSet[place]&&(b=mapViewModel.infoWindowSet[place].getContent(),-1==b.indexOf("Wikipedia")&&(c=mapViewModel.formatInfoHtml(f,b),mapViewModel.infoWindowSet[place].setContent(c)))}},api={callYelp:function(a,b){var c={consumerKey:"TaKtZegj3JmlcXZ4qvefrw",consumerSecret:"LuJGs0Ep_1XkfjKso_k62SDn7js",accessToken:"WTB32nqSvrTL2-eI3gKQZ4Rp6vbPsnTb",accessTokenSecret:"8xdXNsJ5mNRioQLXvK0I4oCDk_I"},d=5,e={consumerSecret:c.consumerSecret,tokenSecret:c.accessTokenSecret};parameters=[],parameters.push(["term",a]),parameters.push(["limit",d]),parameters.push(["location",b]),parameters.push(["callback","pcb"]),parameters.push(["oauth_consumer_key",c.consumerKey]),parameters.push(["oauth_consumer_secret",c.consumerSecret]),parameters.push(["oauth_token",c.accessToken]),parameters.push(["oauth_signature_method","HMAC-SHA1"]);var f={action:"http://api.yelp.com/v2/search",method:"GET",parameters:parameters};OAuth.setTimestampAndNonce(f),OAuth.SignatureMethod.sign(f,e);var g=OAuth.getParameterMap(f.parameters),h=setTimeout(function(){console.log("Yelp call for "+a+" timed out.")},5e3);$.ajax({url:f.action,data:g,dataType:"jsonp",success:function(a,b,c){mapViewModel.addInfo(a,b,c),clearTimeout(h)},error:function(b){console.log("this is the error object "+b),console.log("In error: Sorry, could not find Yelp reviews about "+a)}})},callWiki:function(a){var b=setTimeout(function(){console.log("Wikipedia call for "+a+" timed out.")},5e3);$.ajax({url:"http://en.wikipedia.org/w/api.php",data:"action=opensearch&search="+a+"&format=json",dataType:"jsonp",success:function(a){mapViewModel.addWikiLink(a),clearTimeout(b)},error:function(b){console.log("this is the error object "+b),console.log("In error: Sorry, could not find Wikipedia items about "+a)}})}};ko.applyBindings(listViewModel),listViewModel.find.subscribe(listViewModel.search),window.addEventListener("load",setUpLists());